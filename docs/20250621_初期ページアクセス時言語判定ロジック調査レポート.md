# 初期ページアクセス時言語判定ロジック調査レポート

**作成日**: 2025-06-21  
**作成者**: Claude Code  
**プロジェクト**: DeepHand Web

## 調査概要

DeepHandウェブサイトの初期ページアクセス時におけるJA（日本語）/EN（英語）言語判定ロジックを詳細に調査し、実装状況とルーティング動作を分析しました。

## ディレクトリ構造と基本設定

### 1. Astro設定（astro.config.mjs）
- **サイトURL**: `https://deephandai.com`
- **国際化設定**: Astroの標準i18n設定は使用していない
- **独自言語管理システム**を実装
- **言語プレフィックス**: 英語のみ `/en` を使用

### 2. ページ構造
```
src/pages/
├── index.astro          # 日本語メインページ（/）
├── about.astro          # 日本語個別ページ
├── pricing.astro        # 日本語料金ページ
├── request.astro        # 日本語リクエストページ
└── en/                  # 英語版ディレクトリ
    ├── index.astro      # 英語メインページ（/en/）
    ├── about.astro      # 英語個別ページ
    ├── pricing.astro    # 英語料金ページ
    └── request.astro    # 英語リクエストページ
```

## 言語判定ロジック詳細分析

### 1. メイン言語管理（src/lib/i18n.ts）

#### 初期化処理
```typescript
// デフォルト言語設定
let currentLanguage: 'ja' | 'en' = 'ja';

// ブラウザ環境での初期化
if (typeof window !== 'undefined') {
  const path = window.location.pathname;
  
  // URL優先で言語を判定
  if (path.startsWith('/en')) {
    currentLanguage = 'en';
    localStorage.setItem('language', 'en');
  } else {
    // URL が /en 以外の場合は日本語
    currentLanguage = 'ja';
    localStorage.setItem('language', 'ja');
  }
}
```

#### 重要な判定ルール
1. **URL優先**: パスが `/en` で始まる場合は英語
2. **デフォルト日本語**: その他すべてのパスは日本語
3. **localStorage保存**: 判定結果をローカルストレージに保存

### 2. 設定ファイル（src/i18n/i18n-config.ts）

#### 基本設定
```typescript
export const i18nConfig = {
  supportedLanguages: ['ja', 'en'],
  defaultLanguage: 'ja',          // 日本語がデフォルト
  fallbackLanguage: 'ja',         // フォールバックも日本語
  urlStructure: {
    usePrefix: true,
    prefixDefault: false,         // 日本語にはプレフィックスなし
    pattern: '/:lang/',
  },
  detection: {
    order: ['path', 'localStorage', 'navigator'], // 検出優先順位
  },
};
```

#### 言語検出関数
```typescript
export function getLanguageFromUrl(): SupportedLanguage {
  if (typeof window === 'undefined') {
    return 'ja'; // SSR時はデフォルト日本語
  }

  const pathname = window.location.pathname;
  const segments = pathname.split('/').filter(Boolean);

  if (segments.length === 0) {
    return 'ja'; // ルートパスは日本語
  }

  const firstSegment = segments[0];
  if (firstSegment === 'en') {
    return 'en';
  }
  
  // その他すべてのケースで日本語
  return 'ja';
}
```

### 3. ページレベル設定

#### 日本語メインページ（src/pages/index.astro）
```astro
---
// サーバーサイドで日本語に設定
setCurrentLanguage('ja');
---

<BaseLayout
  title="DeepHand - AI & Robotics Data Annotation Service"
  description="DeepHandはロボティクスに特化したアノテーション専門チームです。"
>
```

#### 英語メインページ（src/pages/en/index.astro）
```astro
---
// サーバーサイドで英語に設定
setCurrentLanguage('en');
---

<BaseLayoutEn
  title="DeepHand - AI & Robotics Data Annotation Service"
  description="DeepHand is a team of annotation experts centered on robotics."
>
```

## アクセス時の動作フロー

### 1. ルートパス（/）アクセス時
1. **ページ**: `src/pages/index.astro`（日本語版）
2. **レイアウト**: `BaseLayout.astro`（`lang="ja"`）
3. **言語設定**: サーバーサイドで `setCurrentLanguage('ja')`
4. **結果**: 日本語コンテンツ表示

### 2. 英語パス（/en）アクセス時
1. **ページ**: `src/pages/en/index.astro`（英語版）
2. **レイアウト**: `BaseLayoutEn.astro`（`lang="en"`）
3. **言語設定**: サーバーサイドで `setCurrentLanguage('en')`
4. **結果**: 英語コンテンツ表示

### 3. その他パス（/about, /pricing等）アクセス時
1. **ページ**: 各日本語版ページ
2. **言語設定**: 日本語として処理
3. **結果**: 日本語コンテンツ表示

## ブラウザ言語検出機能の現状

### 現在の実装状況
**❌ ブラウザ言語自動検出は実装されていない**

- `navigator.language` の使用なし
- `Accept-Language` ヘッダーの確認なし
- ブラウザ設定による自動切り替えなし

### 検出順序設定（i18n-config.ts内）
```typescript
detection: {
  order: ['path', 'localStorage', 'navigator'], // 設定はあるが未実装
}
```

## 言語設定の保存方法

### 1. localStorage使用
- **キー**: `'language'`
- **値**: `'ja'` または `'en'`
- **更新タイミング**: URL判定時とアクセス時

### 2. LanguageSwitcher（別実装）
```typescript
// 異なるキーを使用（統一されていない）
localStorage.setItem('preferred-language', newLanguage);
```

**⚠️ 問題点**: 2つの異なるlocalStorageキーが存在

## 重要な発見事項

### 1. デフォルト言語の優先
- **日本語が明確にデフォルト言語**として設定
- すべての判定でフォールバック先は日本語
- ルートパス（/）は常に日本語

### 2. 言語判定の単純性
- URLパス判定のみに依存
- `/en` で始まる場合のみ英語、その他すべて日本語
- ブラウザ言語設定は考慮されない

### 3. 実装の一貫性
- 各ページで言語設定を明示的に指定
- サーバーサイドとクライアントサイドで一貫した処理
- 専用レイアウトファイルで言語固有設定

### 4. URL構造の明確性
```
日本語: / /about /pricing /request
英語:   /en /en/about /en/pricing /en/request
```

## 推奨改善点

### 1. ブラウザ言語検出の実装
```typescript
// 初回アクセス時のブラウザ言語検出
function detectBrowserLanguage(): 'ja' | 'en' {
  if (typeof navigator !== 'undefined') {
    const language = navigator.language || navigator.languages?.[0];
    return language.startsWith('en') ? 'en' : 'ja';
  }
  return 'ja';
}
```

### 2. localStorage統一
- 2つのキー（`'language'`, `'preferred-language'`）を統一
- 一貫したデータ管理

### 3. 言語切り替え後のリダイレクト改善
- 現在は `window.location.href` で完全リロード
- SPAライクな体験のためにpushStateの活用検討

## まとめ

DeepHandウェブサイトの言語判定ロジックは**URLベースの明確なルーティング**を採用しており、実装は一貫している。ただし、ブラウザ言語の自動検出機能は未実装で、初回アクセス時は常に日本語が表示される。システムの信頼性は高いが、国際的なユーザビリティ向上の余地がある。